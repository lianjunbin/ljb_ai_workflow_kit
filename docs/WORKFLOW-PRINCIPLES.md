# Admin Workflow 设计原则

> **核心原则：APPLY 之前，只做分析设计，不动一行代码**

---

## 架构分层

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   INIT → START → API → BEFORE → DESIGN → AUDIT    │    APPLY → REVIEW → ARCHIVE
│   ├──────────────────────────────────────────────┤    ├─────────────────────────┤
│              分析设计阶段（只读）                  │         执行阶段（写入）     │
│                                                   │                             │
│   ✅ 读取代码                                      │    ✅ 写入代码              │
│   ✅ 分析结构                                      │    ✅ 创建文件              │
│   ✅ 生成文档                                      │    ✅ 修改文件              │
│   ✅ 设计方案                                      │    ✅ 执行命令              │
│   ❌ 禁止写入代码                                  │                             │
│   ❌ 禁止修改文件                                  │                             │
│                                                   │                             │
└───────────────────────────────────────────────────┴─────────────────────────────┘
```

---

## 阶段职责定义

### 分析设计阶段（INIT ~ AUDIT）

| 阶段 | 职责 | 输入 | 输出 | 代码操作 |
|------|------|------|------|----------|
| **INIT** | 项目初始化 | 项目目录 | openspec/ 配置 | ❌ 只创建配置文件 |
| **START** | 需求获取 | Jira 编号 | AI-PRD.md | ❌ 只读代码探索 |
| **API** | 接口收集 | Apifox URL | api.md | ❌ 只读 |
| **BEFORE** | 业务梳理 | PRD + 代码 | before.md（流程图） | ❌ 只读分析 |
| **DESIGN** | 方案设计 | 分析结果 | proposal.md + tasks.md | ❌ 只生成方案 |
| **AUDIT** | 提案审阅 | 提案文件 | 影响分析报告 | ❌ 只读验证 |

### 执行阶段（APPLY ~ ARCHIVE）

| 阶段 | 职责 | 输入 | 输出 | 代码操作 |
|------|------|------|------|----------|
| **APPLY** | 应用代码 | tasks.md | 实际代码文件 | ✅ **写入代码** |
| **REVIEW** | 代码走读 | 改动文件 | 优化建议 | ✅ 可选修改 |
| **ARCHIVE** | 归档提案 | 提案目录 | archives/ 索引 | ❌ 只移动文件 |

---

## 设计原则

### 原则 1：分离分析与执行

```
为什么这样设计？

1. 充分思考再动手
   - 避免边写边改的低效模式
   - 强制完成设计再开始编码

2. 可回退的决策点
   - AUDIT 是最后的确认关卡
   - 不满意可以回到 DESIGN 重新设计
   - 一旦 APPLY，代码已改动

3. 清晰的责任边界
   - 分析阶段：AI 负责思考，人负责决策
   - 执行阶段：AI 负责实现，人负责验收
```

### 原则 2：渐进式信息收集

```
每个阶段只做一件事，为下一阶段提供输入：

START   → 获取需求     → 输出 PRD
API     → 获取接口     → 输出 api.md
BEFORE  → 分析现状     → 输出 before.md（业务流程）
DESIGN  → 设计方案     → 输出 proposal.md + tasks.md
AUDIT   → 审阅确认     → 输出 审阅报告
         ↓
      ═══════════════════════════════════
         ↓ 分析完成，开始执行
APPLY   → 写入代码     → 输出 实际代码
```

### 原则 3：用户始终掌控

```
分析阶段的每一步都支持：
  [Y] 满意，继续下一步
  [N] 不满意，调整当前结果
  [R] 重新执行当前阶段
  [E] 手动编辑输出文件

执行阶段的保护机制：
  - 逐任务确认执行
  - 支持暂停
  - 支持选择性回滚
```

---

## 禁止行为清单

### 分析设计阶段（INIT ~ AUDIT）禁止：

```
❌ 创建 src/ 下的任何文件
❌ 修改 src/ 下的任何文件
❌ 执行 npm/yarn/pnpm install
❌ 执行任何构建命令
❌ 执行任何测试命令（会修改快照）
❌ 执行 git add/commit/push
❌ 修改 package.json
❌ 修改配置文件（tsconfig, vite.config 等）
```

### 分析设计阶段允许：

```
✅ 读取任何文件
✅ 搜索代码
✅ 分析 AST
✅ 生成 Mermaid 图
✅ 创建 openspec/ 下的文档
✅ 调用只读 API（Jira 读取、Apifox 读取）
```

---

## 阶段边界检查

在实现各阶段命令时，必须遵循以下约束：

```typescript
// 分析阶段的工具限制
const ANALYSIS_PHASE_TOOLS = {
  allowed: [
    'Read',           // 读取文件
    'Glob',           // 搜索文件
    'Grep',           // 搜索内容
    'WebFetch',       // 获取网页
    'Task(Explore)',  // 代码探索
    'Task(Plan)',     // 规划设计
  ],
  forbidden: [
    'Write',          // 禁止写入（除 openspec/ 目录）
    'Edit',           // 禁止编辑
    'Bash(写入类)',    // 禁止执行写入命令
  ]
}

// 执行阶段才解锁
const EXECUTION_PHASE_TOOLS = {
  allowed: [
    ...ANALYSIS_PHASE_TOOLS.allowed,
    'Write',          // 允许写入
    'Edit',           // 允许编辑
    'Bash',           // 允许执行命令
  ]
}
```

---

## 变更此文档的流程

> ⚠️ 此文档定义了工作流的核心架构原则，修改需谨慎

如需修改本文档，必须：

1. 说明修改原因
2. 评估对现有流程的影响
3. 更新所有受影响的阶段文档
4. 更新 workflow-diagram.html 中的说明

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0 | 2026-02-11 | 初始版本，明确分析/执行阶段边界 |
