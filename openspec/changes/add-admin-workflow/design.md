# 管理后台 AI 开发工作流 - 设计决策

> **变更 ID**: `add-admin-workflow`
> **版本**: 1.1.0
> **更新日期**: 2026-02-11

---

## 1. 整体架构设计

### 1.1 八阶段工作流架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│           管理后台 AI 开发工作流 v1.1 (Admin Workflow)                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  阶段 0: INIT（项目初始化）                                                      │
│  ├── 检测技术栈（Vue 3 + Vite + TS）                                            │
│  └── 生成 openspec/ 结构                                                        │
│                                ↓                                                 │
│  阶段 1: START（需求获取 + 代码探索）                                            │
│  ├── 从 Jira 拉取需求                                                           │
│  ├── 可选获取 API 文档（Apifox）                                                │
│  ├── 并行启动 code-explorer                                                     │
│  └── 生成 AI-PRD-*.md                                                           │
│                                ↓                                                 │
│  阶段 2: ANALYZE（业务分析）🔄 可多轮迭代                                        │
│  ├── 分析现有功能的业务逻辑                                                      │
│  ├── 识别可复用的代码模式                                                        │
│  └── 生成 before.md 分析报告                                                    │
│                                ↓                                                 │
│  阶段 3: DESIGN（提案设计）🔄 可多轮迭代                                         │
│  ├── 支持 think / think-hard / ultra-think 模式                                 │
│  ├── 多 architect agent 并行设计（TSX + Vue 分离）                              │
│  ├── 用户选择方案                                                               │
│  └── 生成 proposal.md + tasks.md                                                │
│                                ↓                                                 │
│  阶段 4: REVIEW（提案审查）🔄 可多轮迭代                                         │
│  ├── 影响范围分析                                                               │
│  ├── 可行性审查                                                                 │
│  └── 等待用户确认                                                               │
│                                ↓                                                 │
│  阶段 5: APPLY（应用代码）                                                       │
│  ├── 逐任务确认执行                                                             │
│  └── 可暂停 + 选择性回滚                                                        │
│                                ↓                                                 │
│  阶段 6: END（走查）                                                             │
│  ├── code-reviewer 代码质量审查                                                 │
│  ├── code-simplifier 代码简化                                                   │
│  └── Git 提交建议（仅建议，不执行）                                              │
│                                ↓                                                 │
│  阶段 7: ARCHIVE（归档）                                                         │
│  └── 提案归档 + 更新索引                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 多代理协同架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    多代理协同架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  START 阶段                                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │code-explorer│  │code-explorer│  │code-explorer│             │
│  │   类似功能   │  │   架构模式   │  │   组件使用   │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│         └────────────────┼────────────────┘                     │
│                          ↓                                       │
│  ANALYZE 阶段                                                    │
│                 ┌────────────────┐                              │
│                 │  brainstorming │ 🔄                           │
│                 │     业务分析    │                              │
│                 └───────┬────────┘                              │
│                         ↓                                        │
│  DESIGN 阶段                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │code-architect│ │code-architect│ │code-architect│             │
│  │  最小改动   │  │  务实平衡   │  │  清洁架构   │              │
│  │ TSX+Vue 分离│  │ TSX+Vue 分离│  │ TSX+Vue 分离│              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│         └────────────────┼────────────────┘                     │
│                          ↓                                       │
│                   用户选择方案 🔄                                 │
│                          ↓                                       │
│  REVIEW 阶段                                                     │
│                 ┌────────────────┐                              │
│                 │impact-analyzer │ 🔄                           │
│                 │    影响分析    │                               │
│                 └───────┬────────┘                              │
│                         ↓                                        │
│  APPLY 阶段                                                      │
│                 ┌────────────────┐                              │
│                 │   逐任务执行    │                              │
│                 │ 可暂停+选择回滚│                               │
│                 └───────┬────────┘                              │
│                         ↓                                        │
│  END 阶段                                                        │
│  ┌─────────────┐            ┌─────────────┐                    │
│  │code-reviewer │ ────────→ │code-simplifier│                   │
│  │TSX+Vue检查  │            │  代码简化   │                    │
│  └─────────────┘            └─────────────┘                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 目录结构设计

### 2.1 工作流安装目录

```
~/.claude/
├── skills/
│   └── admin-workflow/          # 管理后台工作流
│       ├── admin.md             # 主入口
│       ├── init.md              # 初始化
│       ├── start.md             # 需求获取
│       ├── analyze.md           # 业务分析
│       ├── design.md            # 提案设计
│       ├── review.md            # 提案审查
│       ├── apply.md             # 应用代码
│       ├── end.md               # 走查
│       ├── archive.md           # 归档
│       ├── style-guide.md       # 输出风格
│       └── coding-standards.md  # 编码规范
└── agents/
    ├── code-explorer.md         # 代码探索
    ├── code-architect.md        # 架构设计
    ├── code-reviewer.md         # 代码审查
    ├── code-simplifier.md       # 代码简化
    └── impact-analyzer.md       # 影响分析
```

---

## 3. 关键设计决策

### 3.1 为什么拆分 EXECUTE 为 APPLY/END/ARCHIVE？

**问题**：原 EXECUTE 阶段职责过重，包含执行、审查、简化、归档

**决策**：拆分为三个独立阶段
- **APPLY**: 纯粹的代码应用，支持暂停和选择性回滚
- **END**: 代码质量走查，审查+简化+Git建议
- **ARCHIVE**: 独立归档，复用 OpenSpec 规范

**收益**：
- 职责清晰，易于理解
- 可以在任意阶段暂停
- 选择性回滚不影响走查

### 3.2 为什么支持多轮迭代？

**问题**：ANALYZE/DESIGN/REVIEW 是关键决策阶段，一次性输出可能不满足需求

**决策**：三个阶段都支持多轮迭代
- 完成后询问用户是否满意
- 不满意可补充信息重新执行
- 直到用户确认后才进入下一阶段

**收益**：
- 确保输出质量
- 减少返工
- 用户控制决策

### 3.3 为什么采用 TSX + Vue 分离？

**问题**：Vue 单文件组件容易逻辑膨胀，难以测试和复用

**决策**：强制 TSX + Vue 分离
- `.tsx` 负责 Model（业务逻辑、状态管理）
- `.vue` 负责 View（模板、样式）
- 使用解构赋值导出和接收

**收益**：
- 逻辑可独立测试
- 更好的代码复用
- 清晰的职责分离

### 3.4 为什么选择性回滚？

**问题**：暂停后全部回滚影响用户体验

**决策**：提供选择性回滚
- 暂停后展示已完成任务列表
- 用户选择要保留的任务
- 检查依赖关系，避免破坏依赖

**收益**：
- 保留有效工作成果
- 减少重复劳动
- 更灵活的流程控制

---

## 4. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| MCP 服务未配置 | 无法从 Jira 获取需求 | 安装时检查并引导配置，不阻塞安装 |
| 多代理并行消耗大 | Token 成本高 | 提供不同思考模式，用户可选择 |
| 选择性回滚复杂 | 可能破坏依赖关系 | 自动检查依赖，警告用户 |

---

**文档版本**: v1.1
**最后更新**: 2026-02-11
